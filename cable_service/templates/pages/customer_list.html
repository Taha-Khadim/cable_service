{% extends "templates/web.html" %}

{% block title %}Customer List{% endblock %}

{% block page_content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Customer List</h2>
                <div>
                    <a href="/customer-registration" class="btn btn-primary">Add New Customer</a>
                    <a href="/dashboard" class="btn btn-outline-secondary">Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" class="form-control" id="searchCustomer" placeholder="Search customers...">
        </div>
        <div class="col-md-3">
            <select class="form-control" id="statusFilter">
                <option value="">All Status</option>
                <option value="Active">Active</option>
                <option value="Pending">Pending</option>
                <option value="Inactive">Inactive</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-control" id="paymentFilter">
                <option value="">All Payments</option>
                <option value="Paid">Paid</option>
                <option value="Pending">Pending</option>
                <option value="Partial">Partial</option>
            </select>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="customerTable">
                    <thead>
                        <tr>
                            <th>Customer ID</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>City</th>
                            <th>Service Status</th>
                            <th>Payment Status</th>
                            <th>Total Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers %}
                        <tr>
                            <td>{{ customer.name }}</td>
                            <td>{{ customer.customer_name }}</td>
                            <td>{{ customer.phone }}</td>
                            <td>{{ customer.city or '-' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if customer.service_status == 'Active' else 'warning' if customer.service_status == 'Pending' else 'danger' }}">
                                    {{ customer.service_status }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if customer.payment_status == 'Paid' else 'warning' if customer.payment_status == 'Pending' else 'info' }}">
                                    {{ customer.payment_status }}
                                </span>
                            </td>
                            <td>${{ customer.total_amount or 0 }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewCustomer('{{ customer.name }}')">
                                    View
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="updatePayment('{{ customer.name }}')">
                                    Payment
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Payment Update Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="paymentForm">
                <div class="modal-body">
                    <input type="hidden" id="customerId" name="customer_id">
                    <div class="mb-3">
                        <label class="form-label">Payment Amount</label>
                        <input type="number" class="form-control" name="payment_amount" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Mode</label>
                        <select class="form-control" name="payment_mode" required>
                            <option value="Cash">Cash</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Card">Card</option>
                            <option value="Online">Online</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Status</label>
                        <select class="form-control" name="payment_status" required>
                            <option value="Paid">Paid</option>
                            <option value="Pending">Pending</option>
                            <option value="Partial">Partial</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Date</label>
                        <input type="date" class="form-control" name="payment_date" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function updatePayment(customerId) {
    document.getElementById('customerId').value = customerId;
    document.querySelector('[name="payment_date"]').value = new Date().toISOString().split('T')[0];
    new bootstrap.Modal(document.getElementById('paymentModal')).show();
}

function viewCustomer(customerId) {
    window.open('/app/customer-profile/' + customerId, '_blank');
}

document.getElementById('paymentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    frappe.call({
        method: 'frappe.client.set_value',
        args: {
            doctype: 'Customer Profile',
            name: formData.get('customer_id'),
            fieldname: {
                'payment_amount': parseFloat(formData.get('payment_amount')),
                'payment_mode': formData.get('payment_mode'),
                'payment_status': formData.get('payment_status'),
                'payment_date': formData.get('payment_date')
            }
        },
        callback: function(r) {
            if (r.message) {
                location.reload();
            }
        }
    });
});

// Search and filter functionality
document.getElementById('searchCustomer').addEventListener('input', filterTable);
document.getElementById('statusFilter').addEventListener('change', filterTable);
document.getElementById('paymentFilter').addEventListener('change', filterTable);

function filterTable() {
    const searchTerm = document.getElementById('searchCustomer').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const paymentFilter = document.getElementById('paymentFilter').value;
    const rows = document.querySelectorAll('#customerTable tbody tr');
    
    rows.forEach(row => {
        const name = row.cells[1].textContent.toLowerCase();
        const phone = row.cells[2].textContent.toLowerCase();
        const status = row.cells[4].textContent.trim();
        const payment = row.cells[5].textContent.trim();
        
        const matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesPayment = !paymentFilter || payment === paymentFilter;
        
        row.style.display = matchesSearch && matchesStatus && matchesPayment ? '' : 'none';
    });
}
</script>
{% endblock %}